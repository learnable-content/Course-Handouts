Refactoring the Code

Now we're going to have a go at refactoring the code forthe Play Your Cards Right Sinatra app that we created in the last lesson.Refactoring code is the process of improving its structure andmaintainability without actually changing its behavior.What we're going to do is replace some of the chunks of code with methods.This will make the code easier to follow and easier to maintain,because if we want to make a change to some of the functionality,all we'll need to do is change the method in just one place.I've rewritten the app in this file that you can see here.It's called play_your_cards_right_v2, for version two.Now, remember, the app only used two route handlers.Well they were quite big and complex so I've rewritten them using methods,which makes it much easier to read and see what's going on.This is because I've chosen some descriptive method namesmaking the code more readable, almost like English in some places.Let's take a look at some of these route handlers.We'll start with the first one.The first route handler that you can see here sets up the game andthen redirects the player to the play cards route.In fact, I shouldn't even need to explain this because it says it right herein the code.Here we have a method called set_up_game.And all of the code that actually sets up the gamehas been extracted into this method.This tidies up the route handler, and makes it clear what's happening.Redirect and to, that you can see here,are both methods that are built into Sinatra.And have been purposely named sothat the code in a route handler reads almost like English.You can see it just says, redirect to, and then thisURL here is actually an argument that send it into the method.
draw_card Method

The other route handler deals with the game play,and this is also being rewritten to make it easier to follow what's happening.It's also much shorter than it was before.You can see it all here.We start with a method called draw_card andit assigns a card to the variable card.We also use a method to find the value of the card.This method is actually called value_of.You can see it here.And card is actually the argument of that method.I've purposely chosen this as a name sothat when we write them together it reads very much like English.Next we have a big if statement to check if the player has guessed correctly on it.And we can see the if statements here.Instead of using all those long conditions that we had before, I've extracted all ofthat logic into this method called player_has_a_losing,and this takes an argument called value.Once again, this combination of the name of method andits parameter name is used to make the code more descriptive.After this, we use some more methods to deal with what happens if the playerhas a losing value or not.
Method game_over

This is a method called game_over, andit takes an arguments of card, which will be the current card.If the player doesn't lose, we go into this else section here, andwe do two things.First of all, we update the session with the value of the card.
Method update_session_with

And the method is called update_session_with.And value here is an argument representing the value of the card.The next method is called ask_about andit also takes the current card as an argument, here.Both of these methods,again, are very descriptive because they describe exactly what we want to do.We want to update the session with the value of the card,and then we want to ask the player about the card.So as you can see, by using methods we've made the route handlers much shorter, andthey're also far clearer In describing what actually happens.Basically, we go through everything,we setup the game, then redirect the player to the play cards route.Then when we get to that mode, we draw a card,find its value and assign those both to variables.Then we check to see if the player has a losing value.If so then it's game over for that card.Or else we're going to update the session with that value andwe're going to ask about the new card.As we've seen by that, we've made the code extremely readable and descriptive.By using different methods inside the route handlers andnaming them appropriately.But where do all these methods go?
Helper Methods

Well, Sinatra uses the concepts of helper methodsto describe methods that are used in route handlers and views.These are placed in a helpers block, and it can actually go anywhere in the code,but it's usually placed near the beginning.And if I go to the beginning of this file,I was actually at the end of the file then.If we scroll up to the start of the file,we can see here the helpers block starts with the do keyword.All the helper methods are written after the do keyword, and it finishes down herewith the end keyword here just before the wrap handlers start.Everything in-between are classed as helper methods, andthey can be used inside the wrap handlers.They can also be used inside the views, as well.Let's take a look at some of these helper methods.Most of the code is very similar to the code that we used in the last lesson.So it should be very familiar to you.The first helper method is the set_up_game method that we can see here.This sets a session variable as an array andthen it creates a deck of cards by iterating through thesetwo arrays like we've done in the lessons earlier.It then shuffles that deck of cards that's stored in the session andit also sets up the number of guesses starting at negative one.And there like we did before.
Method value_of

The next method is called value of andthis has to be given an argument of card and this will be providedas string and it will look at the string to find out what the value of the card is.So the string will represent the card.It may say, queen of hearts.And it's the same that we did in the earlier lessons.We're going to look at the first letter, represented here, and we're going to checkwhat that is, if it's a letter we'll give it a value depending on which card it is.
to_i Method

Otherwise, we'll use the to_i method to just return the integerthat the string starts with.The next helper method is used to check if the player has guessed correctly or not.And it's actually called, player_has_a_losing, andvalue is entered from the value of the card, as an argument.This method returns true or false.And it does it by checking to see if the value end to this an argument,which will come form here, and it comes from the current card,is higher or lower than the value stalled in sessionunder the key of value which is actually, the previous card's value.It then compares this to the player's guess,which is stored in the params hash with a key of guess.Now, all of this is quite a bit logic statement it gets quite complicated.So, it's much better to extract this out of the route handlers andinto the helpers block.Where it can stay out of the way and keep the route handlers much more simple andeasier to read.The next helper method is the draw_card helper method.Now, this simply takes the session, the deck of cards held in the session,and uses the pop method to take a card from the end of the array.And it doesn't really do much except it just makesthings more descriptive because we want to actually write.We're going to draw the card because in our game that's what we're doing andthat's actually more descriptive than using the word session and the method pop.Which maybe isn't as clear what's happening, so even though thisis a short method, then it still makes all our code easier to read, andsometimes we do things, sometimes to clear up and make the routes shorter.Other times some of the methods are used to make the code easier to read.Then we have the game_over function andthis simply returns a string telling the player that the game is over.Again this is a long string that clogged up the route handler in the earlier lessonmaking it harder to follow.So it's much better to be extracted out as a helper method.This needs to take the current card as an argument, sothat we can tell the player what the card was, using string interpolation.
Using String Interpolation.

And you can see that here, so the currentcard is entered as an argument, and it's used inside the string there.The update_session_with method that you can see here takes an argument of value.This will be the value of the current card.And this does exactly what it says.It updates the value stored in the session here with the valueof the current card so it's stored for the next round andit also increases the number of guesses that's stored in the session by one.
Helper Method called ask_about

The last helper method is called ask_about, andit takes the current card as an argument as you can see here.And this simply returns this string here.And asks the player whether the card is higher or lower.Now again, although it's only a basic method that doesn't really do much exceptreturn a string, it helps to make the route handlers much tidier andeasier to read, as we saw when we were going through the route handlers.Now one thing you may be wondering about some of these helper methodsis why we had to supply either the card orvalue as a parameter to the methods like we did in these last two methods here.When both card and value,both existed already as variables inside in the router handlers.Well, this is because of the scope of variables,which is the places in which the code where variables are accessible.A variable can only be accessed inside a method if it has beencreated in that method, or if it's been entered as an argument.So the variables card and value are not available in any of the helper methods,even if they are mentioned inside the route handler that calls the helper methodunless we supply that as an argument to the method.A method doesn't have access to any variable created outside of it.They need to be entered as arguments to the method,like we've done in both of these examples.In a similar way,a variable created inside a method is only available inside that method scope.That's the last of all our helper methods, solet's check to see if everything runs okay.
Running the Program

First of all, and just needs to open up a terminal and start a server running.And I do that by typing ruby, and then the file name.Which if you remember was, play_your_cards_rightv2.rb, press Enter.We can see a server starts up.And then if I go into my browser,we go to localhost on the port:4567, if I press Enter,we can see the game has been set up and I've been redirected.And this is the ask_about method, that card has been picked.4 of spades and it asks me whether I want to pick higher or lower.So let's run through game.It's the same value that lets you play again.Still the same value, the 4.And I'm going to just keep going higher.Now we'll try lower.Keep going, and eventually, it's game over.And that will run the game over method.You can see the card was actually the 2 of Clubs, but I made 12 correct guesses,which is drawn from the session.Now, as you can see this runs exactly the same as before.The game isn't any different.But that's what we wanted to happen when we re-factor code.There shouldn't be any changes in how the program runs, butthe code should be much more readable and maintainable.Which is exactly what we've done here.
Methods and Objects

Now, that's all for methods.Hopefully, this lesson has helped to introduce methods andshown how useful they can be in making your code more flexible,maintainable, reusable, and easier to read.As long as they're well named, remember.The methods we were writing in this tutorialwere actually more like functions.As I mentioned in the very first lesson of this course,Ruby is actually an object orientated language.And the methods are methods of objects.Now, the methods we've been writing are actually all methods of a specialobject in Ruby called main.I've included a link with more information about this in the resources section below.
End of the Lesson

And in the next lesson, we're going to be looking at how Ruby's class andobject system works.In the meantime, please leave any comments orquestions that you might have in the comment section below.See you soon.